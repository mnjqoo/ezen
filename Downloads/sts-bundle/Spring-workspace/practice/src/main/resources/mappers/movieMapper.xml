<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
      PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.practice.movie">
	
	<!-- 검색조건 -->
	<sql id="search">
		<if test="searchType != null">
			<if test='searchType == "t"'>
				AND m.title LIKE CONCAT('%', #{keyword}, '%')
			</if>
			<if test='searchType == "g"'>
				AND g.genre LIKE CONCAT('%', #{keyword}, '%')
			</if>
			<if test='searchType == "r"'>
				AND m.rating LIKE CONCAT('%', #{keyword}, '%')
			</if>
			<if test='searchType == "d"'>
				AND m.director LIKE CONCAT('%', #{keyword}, '%')
			</if>
		</if>
	</sql>
	
	<!-- 총 데이터 건 수 구하기 -->
	<select id="totalCount" parameterType="com.practice.common.util.SearchCriteria" resultType="Integer">
		<![CDATA[
		SELECT COUNT(*)
		FROM movies_table m, genre_table g
		WHERE m.genre_code = g.genre_code
		]]>
		<include refid="search"/>
		
	</select>
	
	<!-- 게시글 목록 불러오기 -->
	<select id="movieList" parameterType="com.practice.common.util.SearchCriteria" resultType="com.practice.movies.dto.MovieDTO">
		<![CDATA[
		SELECT bno, title, genre, releaseDate, raiting, director
		FROM (SELECT m.bno, m.title, g.genre, m.releaseDate, m.raiting, m.director, ROW_NUMBER() OVER(ORDER BY bno DESC) AS rNUM
			  FROM movies_table m, genre_table g
			  WHERE m.genre_code = g.genre_code
		]]>
		<include refid="search"/>
		<![CDATA[
		) brd
		WHERE rNUM BETWEEN (#{perPageNum} * #{pageNum} - 4) and (#{perPageNum} * #{pageNum})
		ORDER BY bno DESC;
		]]>
	</select>
</mapper>   
